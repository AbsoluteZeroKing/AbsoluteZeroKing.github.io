<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>cs架构udptcp报文重构项目-计算机网络 | Leesdog的博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="alternate" type="application/rss+xml" href="https://example.vuepress-theme-blog.billyyyyy3320.com/rss.xml" title="Leesdog的博客 RSS Feed">
    <meta name="description" content="整个系统需要完成一个迷你魔兽的搭建，包括游戏逻辑与客户端服务器的网络交互">
    
    <link rel="preload" href="/assets/css/0.styles.60a10e49.css" as="style"><link rel="preload" href="/assets/js/app.762240e8.js" as="script"><link rel="preload" href="/assets/js/7.ac404b9a.js" as="script"><link rel="preload" href="/assets/js/5.7b7cf407.js" as="script"><link rel="preload" href="/assets/js/27.c846cf16.js" as="script"><link rel="preload" href="/assets/js/8.b02a8171.js" as="script"><link rel="prefetch" href="/assets/js/10.ae5cb994.js"><link rel="prefetch" href="/assets/js/11.5014d578.js"><link rel="prefetch" href="/assets/js/12.27daf7f8.js"><link rel="prefetch" href="/assets/js/13.2c5e2571.js"><link rel="prefetch" href="/assets/js/14.b33af101.js"><link rel="prefetch" href="/assets/js/15.1e840a07.js"><link rel="prefetch" href="/assets/js/16.38daadbf.js"><link rel="prefetch" href="/assets/js/17.84b7c4ed.js"><link rel="prefetch" href="/assets/js/18.43381c27.js"><link rel="prefetch" href="/assets/js/19.b37aff45.js"><link rel="prefetch" href="/assets/js/20.169aefa2.js"><link rel="prefetch" href="/assets/js/21.aebd7e03.js"><link rel="prefetch" href="/assets/js/22.6dd904da.js"><link rel="prefetch" href="/assets/js/23.187e2dbe.js"><link rel="prefetch" href="/assets/js/24.fbf066c4.js"><link rel="prefetch" href="/assets/js/25.9f79a7ba.js"><link rel="prefetch" href="/assets/js/26.0847b1c1.js"><link rel="prefetch" href="/assets/js/28.93bf2646.js"><link rel="prefetch" href="/assets/js/29.4359646b.js"><link rel="prefetch" href="/assets/js/3.09d94a24.js"><link rel="prefetch" href="/assets/js/30.06365a24.js"><link rel="prefetch" href="/assets/js/31.266c0527.js"><link rel="prefetch" href="/assets/js/32.2dbb722b.js"><link rel="prefetch" href="/assets/js/33.d27f2f5b.js"><link rel="prefetch" href="/assets/js/34.c5f4f4b8.js"><link rel="prefetch" href="/assets/js/4.7d2ea1e7.js"><link rel="prefetch" href="/assets/js/6.06fc81ac.js"><link rel="prefetch" href="/assets/js/9.0d6b80d6.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.e0d5157c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.60a10e49.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><header class="header"><div class="headerTitle"><a href="/" class="nav-link headerTitleLink">Leesdog的博客 </a></div> <div class="headerTags"><ul class="headerTagsNav"><li class="headerTagsNavItem"><a href="/" class="nav-link">首页</a></li><li class="headerTagsNavItem"><a href="/blog/" class="nav-link">记录</a></li><li class="headerTagsNavItem"><a href="/tags/" class="nav-link">标签</a></li><li class="headerTagsNavItem"><a href="/about/" class="nav-link">关于</a></li></ul></div> <div id="headerComponent"><div id="searchBox" class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></header> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Leesdog的博客 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">记录</a></li><li class="mobile-nav-item"><a href="/tags/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">关于</a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        cs架构udptcp报文重构项目-计算机网络
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-04-30T14:14:58.000Z">
      2020-04-30 14:14
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-5b1568b2><a href="/tags/计算机网络" data-v-5b1568b2><span data-v-5b1568b2>计算机网络</span></a></li><li class="post-tag" data-v-5b1568b2><a href="/tags/UDP" data-v-5b1568b2><span data-v-5b1568b2>UDP</span></a></li><li class="post-tag" data-v-5b1568b2><a href="/tags/TCP" data-v-5b1568b2><span data-v-5b1568b2>TCP</span></a></li><li class="post-tag" data-v-5b1568b2><a href="/tags/Java" data-v-5b1568b2><span data-v-5b1568b2>Java</span></a></li><li class="post-tag" data-v-5b1568b2><a href="/tags/报文重构" data-v-5b1568b2><span data-v-5b1568b2>报文重构</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="计算机网络课程设计"><a href="#计算机网络课程设计" class="header-anchor">#</a> 计算机网络课程设计</h2> <h3 id="题目描述"><a href="#题目描述" class="header-anchor">#</a> 题目描述</h3> <blockquote><p>1A1B:假想作为“暴雪”公司的首席工程师，你被分配了一个任务——为新的线上竞技游戏设计并实现网络协议。过去的经验告诉你，对项目采用不断演化的开发方法是个好主意，所以你决定首先实施其框架版本“迷你魔兽世界（tiny World of Warcraft ，TWW)”。通过框架的实现，你期望能证实客户端-服务器架构及协议是正确的。
2A：你在项目1中实现的“迷你魔兽世界（tiny World of Warcraft ，TWW)”大获成功。此成功带来大量新增用户,从而服务器过载。为了克服此问题，你决定重构你的客户机和服务器以获得所需要的可扩展性。
现在，需要使用多台服务器。每台服务器仅处理地牢(dungeon)的特定地理区域。为了避免数据不一致性的问题，客户端软件要从指定位置取出玩家的状态，并在登陆时提供给合适的服务器。而当玩家从地牢的一块区域移动到另一块区域时，客户端软件要确保其连接到正确的服务器。最后，当玩家登出时, 客户端要把更新的状态信息存储到指定位置。我们将使用跟踪器（tracker)来给客户端提供执行这些任务的必要信息。
在本项目中，你需要修改客户机和服务器以完成前述目标。你还要实现tracker.</p></blockquote> <h3 id="系统需求概述"><a href="#系统需求概述" class="header-anchor">#</a> 系统需求概述</h3> <p>整个系统需要完成一个迷你魔兽的搭建，包括游戏逻辑与客户端服务器的网络交互；在2A中我们需要完成地图的分离处理与交互，在2B中我们需要完成P2P的实现</p> <p><a href="https://leesdog.space/upload/2021/02/1.Warcraft%20-ceb4f41cb4d740df801063fb66c5f7a9.doc" target="_blank" rel="noopener noreferrer">1A要求文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://leesdog.space/upload/2021/02/2A.Warcraft-21e8f623186c4194b2751fe948b2c53a.doc" target="_blank" rel="noopener noreferrer">2A要求文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://leesdog.space/upload/2021/02/2B.Warcraft-da6ff1c1d2104f198f6036c9c1f37b25.doc" target="_blank" rel="noopener noreferrer">2B要求文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="功能性需求"><a href="#功能性需求" class="header-anchor">#</a> 功能性需求</h3> <ol><li>客户端方的协议功能实现：</li></ol> <p>①登录：通过玩家的账号登陆，如果没有账号，则创建一个并且登陆。</p> <p>②移动：朝某个方向移动3个距离</p> <p>③攻击：攻击某个玩家，这个玩家必须在视线范围内</p> <p>④广播：广播对话消息</p> <p>⑤登出：退出游戏，并且保存当前玩家的状态</p> <ol start="2"><li>服务器方的协议功能实现：</li></ol> <p>①登录响应：响应客户端的登陆，如果没有账号，则创建一个并且登陆。</p> <p>②移动响应：响应客户端的移动，同时广播移动后的消息</p> <p>③攻击响应：响应客户端的攻击，这个玩家必须在视线范围内</p> <p>④广播响应：响应客户端的广播，并广播对话消息至所有在线服务器</p> <p>⑤登出：响应客户端的登出，并且保存当前玩家的状态</p> <ol start="3"><li>Tracker方的协议功能实现</li></ol> <p>①登录响应：响应客户端的登陆，以名字hash对登录者划分服务器</p> <p>②移动响应：响应客户端的移动，当跨服后执行logout+新服务器login</p> <p>③攻击响应：响应客户端的攻击，这个攻击应该不能跨服</p> <p>④广播响应：响应客户端的广播，广播消息应能达到跨服效果</p> <h3 id="非功能性需求"><a href="#非功能性需求" class="header-anchor">#</a> 非功能性需求</h3> <ol><li>对重复登录做出反应</li> <li>对登录名格式错误做出反应</li> <li>对命令格式错误做出反应</li> <li>对已有同名角色登录做出反应</li> <li>对move后的视野判断问题做出解决</li> <li>对attack攻击无对象或自己做出处理</li> <li>对attack攻击超范围做出处理</li> <li>对speak长度进行控制</li> <li>对执行其他命令时未login做出反应</li> <li>2A对服务器进行分流分图后的消息传递进行处理</li></ol> <p><img src="https://leesdog.space/upload/2021/02/%E8%AE%A1%E5%9B%BE-651a2290113f4e4e85b92a5599071fcc.png" alt="计图"> <img src="https://leesdog.space/upload/2021/02/%E8%AE%A1%E5%9B%BE2A-ce71a7a8d1b540d9abea4e814bdde67e.png" alt="计图2A"></p> <h3 id="day0x01"><a href="#day0x01" class="header-anchor">#</a> Day0x01</h3> <p>今天首先在云服上把环境给配好了</p> <p>因为是准备使用java，首先将服务器转换成Ubuntu的题目规范系统</p> <p>然后安装java jdk</p> <p>首先下载了我所使用的jdk，然后通过Winscp传过去</p> <h3 id="解压安装包jdk-8u202-linux-x64-demos-tar-gz"><a href="#解压安装包jdk-8u202-linux-x64-demos-tar-gz" class="header-anchor">#</a> 解压安装包jdk-8u202-linux-x64-demos.tar.gz</h3> <div class="language- extra-class"><pre class="language-text"><code> tar -zxvf jdk-8u161-linux-x64-demos.tar.gz
</code></pre></div><h3 id="将解压后的文件移到-usr-lib目录下"><a href="#将解压后的文件移到-usr-lib目录下" class="header-anchor">#</a> 将解压后的文件移到/usr/lib目录下</h3> <p>切换到/usr/bin目录下</p> <div class="language- extra-class"><pre class="language-text"><code> cd /usr/lib
</code></pre></div><p>并新建jdk目录</p> <div class="language- extra-class"><pre class="language-text"><code> sudo mkdir jdk
</code></pre></div><p>将解压的jdk文件移动到新建的/usr/lib/jdk目录下来</p> <div class="language- extra-class"><pre class="language-text"><code> sudo mv ~/jdk1.8.0_161/usr/lib/jdk
</code></pre></div><p>执行命令后可到 <strong>usr/lib/jdk</strong> 目录下查看是否移动成功</p> <h3 id="配置java环境变量"><a href="#配置java环境变量" class="header-anchor">#</a> 配置java环境变量</h3> <p>这里是将环境变量配置在etc/profile，即为所有用户配置JDK环境。</p> <p>使用命令打开/etc/profile文件</p> <div class="language- extra-class"><pre class="language-text"><code> sudo vim /etc/profile
</code></pre></div><p>在末尾添加以下几行文字：</p> <div class="language- extra-class"><pre class="language-text"><code>#set java env
export JAVA_HOME=/usr/lib/jdk/jdk1.8.0_161
export JRE_HOME=${JAVA_HOME}/jre    
export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib    
export PATH=${JAVA_HOME}/bin:$PATH
</code></pre></div><h3 id="执行命令使修改立即生效"><a href="#执行命令使修改立即生效" class="header-anchor">#</a> 执行命令使修改立即生效</h3> <div class="language- extra-class"><pre class="language-text"><code> source /etc/profile
</code></pre></div><p><img src="http://image.leesdog.space/os-1.png" alt=""></p> <p>java环境配置成功</p> <p>然后今天阅读了一下文档的相关信息，首先了解项目，由于我们要实现通信，首先需要定义一下我们传送的包内容的协议格式，我们已经从socket编程中学过，TCP将所有的消息处理成一个的节流。因此，我们需要生成一个消息头来指定每个消息的长度。</p> <p>首先我们回顾一下TCP协议的报文格式：</p> <p><img src="http://image.leesdog.space/os-2.png" alt=""></p> <p>●源、目标端口号字段：占16比特。TCP协议通过使用”端口”来标识源端和目标端的应用进程。端口号可以使用0到65535之间的任何数字。在收到服务请求时，操作系统动态地为客户端的应用程序分配端口号。在服务器端，每种服务在”众所周知的端口”（Well-Know Port）为用户提供服务。</p> <p>●顺序号字段：占32比特。用来标识从TCP源端向TCP目标端发送的数据字节流，它表示在这个报文段中的第一个数据字节。</p> <p>●确认号字段：占32比特。只有ACK标志为1时，确认号字段才有效。它包含目标端所期望收到源端的下一个数据字节。</p> <p>●头部长度字段：占4比特。给出头部占32比特的数目。没有任何选项字段的TCP头部长度为20字节；最多可以有60字节的TCP头部。</p> <p>●标志位字段（U、A、P、R、S、F）：占6比特。各比特的含义如下：</p> <p>◆URG：紧急指针（urgent pointer）有效。</p> <p>◆ACK：为1时，确认序号有效。</p> <p>◆PSH：为1时，接收方应该尽快将这个报文段交给应用层。</p> <p>◆RST：为1时，重建连接。</p> <p>◆SYN：为1时，同步程序，发起一个连接。</p> <p>◆FIN：为1时，发送端完成任务，释放一个连接。</p> <p>●窗口大小字段：占16比特。此字段用来进行流量控制。单位为字节数，这个值是本机期望一次接收的字节数。</p> <p>●TCP校验和字段：占16比特。对整个TCP报文段，即TCP头部和TCP数据进行校验和计算，并由目标端进行验证。</p> <p>●紧急指针字段：占16比特。它是一个偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号。</p> <p>●选项字段：占32比特。可能包括”窗口扩大因子”、”时间戳”等选项。</p> <p>根据此格式我们结合文档内容进行协议的定义</p> <p>1、Version：8位。指定协议的版本号。版本号目前固定为4。</p> <p>2、Total length：16位的网络字节尾数。指定消息的字节长度，包括包头。</p> <p>3、Msg type：8位。指定消息的类型。在下面的章节会列举消息的类型。</p> <p>4、Per-msg payload：可变长度，这取决于消息的类型。</p> <p><img src="http://image.leesdog.space/os-3.png" alt=""></p> <p>明天对TCP消息的传递沟通做具体的客户端服务器的实现</p> <hr> <h3 id="day0x02"><a href="#day0x02" class="header-anchor">#</a> Day0X02</h3> <p>今天我们来实际先构建一下客户端与服务器</p> <p>首先我们抛弃老师文件里的各种要求，单纯实现一个基于双方通信的多客户端与服务端结构出来</p> <p>通过之前java的web服务器编写，我们可以基本了解到java中传输信息的方式，主要是利用Socket类以及.net包中的ServerSocket</p> <p><strong>服务器端：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>


    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建服务器对象,并指定端口号</span>
        <span class="token class-name">ServerSocket</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务器已经建立......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Socket</span> socket <span class="token operator">=</span>server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端连接进来了......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//当有客户端连接进来以后，开启一个线程，用来处理该客户端的逻辑,</span>
            <span class="token class-name">ServerThread</span> st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerThread</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            st<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加该客户端到容器中</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>客户端</strong>：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Socket</span> client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">InputStream</span> ins <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">OutputStream</span> ous <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这样双方的连接就构建上了，接下来是解决基本通信问题，首先是服务器端发送请输入账号密码的消息并等待接收</p> <p><strong>服务器端：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取输入输出流</span>
            ins <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ous <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送消息给客户端</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;welcome to lee's server !&quot;</span><span class="token punctuation">;</span>
            <span class="token function">sendMsg</span><span class="token punctuation">(</span>ous<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送要求登录信息给客户端</span>
            <span class="token class-name">String</span> userinfo <span class="token operator">=</span> <span class="token string">&quot;please input your name and password ，use&amp; to 分割&quot;</span><span class="token punctuation">;</span>
            <span class="token function">sendMsg</span><span class="token punctuation">(</span>ous<span class="token punctuation">,</span> userinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取客户端输入的用户名</span>
            <span class="token class-name">String</span> userNamekey <span class="token operator">=</span> <span class="token function">readMsg</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> succeessLoginOrNot <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>userNamekey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>succeessLoginOrNot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msg<span class="token operator">=</span><span class="token string">&quot;Fail to connect server......&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;please check your name and password and login again.....&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;please input your name and password ，use&amp; to 分割&quot;</span><span class="token punctuation">;</span>
                <span class="token function">sendMsg</span><span class="token punctuation">(</span>ous<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取客户端输入的用户名</span>
                userNamekey <span class="token operator">=</span> <span class="token function">readMsg</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
                succeessLoginOrNot <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>userNamekey<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//检查数据库</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ins<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ous<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将当前已经关闭的客户端从容器中移除</span>
                <span class="token class-name">MyServer</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre></div><p><strong>客户端：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token function">readMsg</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">HnadleMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//处理信息</span>
 <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readMsg</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> ins<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> value <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 代表客户单不正常关闭</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            str <span class="token operator">=</span> str <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
            value <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>至此，一个基本的双方的多线程通信构建完成</p> <p>但我们实际上的游戏服务器与客户端之间的通信并非这么简单，虽然我们看似解决了双方的通信问题，但在真实游戏情况下是<strong>三方甚至更多方通信</strong>，也就是服务器同时处理多个客户端消息，并且需要达到一个<strong>异步正确处理消息</strong>的要求，也就是在网络速度不一的情况下，能根据消息的时间戳决定消息的处理结果，例如，一个玩家A攻击了玩家B，A攻击时B本来是在A的攻击范围内的，但由于消息发送较慢，这时B进行了移动且消息更快到达，这就会导致A攻击不到B，但在实际情况下A确实是应该能攻击到的，这种情况也要做一些处理；这些内容的实现我们需要依靠相关协议来实现;同时，这一次我们的消息是基于位的协议构造的消息，而不是简单的socket消息，这也是需要解决的问题</p> <p>正如我们上次所研究的tcp结构，具体在此项目中，我们所需构建的报文结构如下图</p> <p><img src="http://image.leesdog.space/os-4.png" alt=""></p> <p>其中IP头和TCP头是可以通过javaSocket编程自动完成的，我们所需要实现的就是后面两个东西，结合前面所学到的知识我们可以知道，包头消息的长度均为32位，故之后我们所处理的消息均为以下这种格式</p> <p><img src="http://image.leesdog.space/os-5.png" alt=""></p> <p>具体来讲我们需要处理以下这几种消息</p> <ul><li><p>LOGIN_REQUEST</p></li> <li><p>LOGIN_REPLY</p></li> <li><p>Move</p></li> <li><p>MOVE_NOTIFY</p></li> <li><p>ATTACK</p></li> <li><p>ATTACT_NOTIFY</p></li> <li><p>SPEAK</p> <p>我们对这些消息构建一个枚举类型的类，之后根据消息编号进行分类处理</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
    LOGIN_REQUEST<span class="token punctuation">,</span>
    LIGIN_REPLY<span class="token punctuation">,</span>
    MOVE_NOTIFY<span class="token punctuation">,</span>
    ATTACT_NOTIFY<span class="token punctuation">,</span>
    MOVE<span class="token punctuation">,</span>
    ATTACK<span class="token punctuation">,</span>
    SPREAK<span class="token punctuation">,</span>
    LOGOUT
<span class="token punctuation">}</span>
</code></pre></div><p>和我们之前写的代码的处理不一样的是，这里我们应该根据tcp包头的消息内容中<strong>消息编号</strong>的不同来调用不同的函数，并将此消息以<strong>函数参数</strong>形式传递给该函数供该函数继续解析，而不是像我们之前那样直接根据传入的字符串进行解析分类，消息编号由于上图协议的规定<strong>必定在</strong>32位信息的<strong>25-32位处</strong>，而其他信息则由不同的函数进行不同的解析方式</p></li></ul> <p>明天我们来实现以上消息的解析分类与实现</p> <hr> <h3 id="day0x03"><a href="#day0x03" class="header-anchor">#</a> Day0X03</h3> <p>昨天我们实现了基础的Socket多线程通信，今天我们来实现消息的解析分类与实现</p> <p>首先是login_request</p> <ul><li><p>LOGIN_REQUEST</p> <p><img src="http://image.leesdog.space/os-6.png" alt=""></p> <p><img src="http://image.leesdog.space/os-7.png" alt=""></p> <p>根据以上的协议我们可以知道整个tcp正文内我们需要构建的大小是8×4×4位的大小的信息，其中如果我们将所有信息都=协议都看一下的话会发现第一行的内容也就是第一个8×4的内容恒定是：</p> <ul><li><p>Version：8位。指定协议的版本号。版本号目前固定为4。</p></li> <li><p>Total length：16位的网络字节尾数。指定消息的字节长度，包括包头。</p></li> <li><p>Msg type：8位。指定消息的类型。</p></li></ul></li></ul> <p>所以为了之后其他消息的实现，我们可以做一些处理：</p> <p><strong>客户端：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Scanner</span> sc<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> ctype<span class="token operator">=</span>sc<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageType</span> type<span class="token operator">=</span><span class="token function">judgeMessageType</span><span class="token punctuation">(</span>ctype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleMessage</span><span class="token punctuation">(</span>ins<span class="token punctuation">,</span>ous<span class="token punctuation">,</span>type<span class="token punctuation">,</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时我们需要重写一下我们之前所写的客户端代码，以适应协议</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Socket</span> client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端已经建立......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">InputStream</span> ins <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">OutputStream</span> ous <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">MessageType</span> <span class="token function">judgeMessageType</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;login&quot;</span><span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span>LOGIN_REQUEST<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token string">&quot;move&quot;</span><span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span>MOVE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token string">&quot;attack&quot;</span><span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span>ATTACK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token string">&quot;speak&quot;</span><span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span>SPREAK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token string">&quot;logout&quot;</span><span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span>LOGOUT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span>UNCLEAR_MESSAGE<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> ins<span class="token punctuation">,</span> <span class="token class-name">OutputStream</span> ous<span class="token punctuation">,</span> <span class="token class-name">MessageType</span> messageType<span class="token punctuation">,</span><span class="token class-name">Scanner</span> sc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>messageType<span class="token operator">==</span><span class="token class-name">MessageType</span><span class="token punctuation">.</span>LOGIN_REQUEST<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;请输入账号&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> account<span class="token operator">=</span>sc<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">login</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span>ous<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>messageType<span class="token operator">==</span><span class="token class-name">MessageType</span><span class="token punctuation">.</span>UNCLEAR_MESSAGE<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后我们通过handleMessage判断MessageType消息信息的种类，然后调用不同的方法，例如我们现在实现的login：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> account<span class="token punctuation">,</span> <span class="token class-name">OutputStream</span> ous<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">byte</span> name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//最大为9字节，最后一位为空</span>
    <span class="token keyword">char</span> len<span class="token operator">=</span><span class="token number">0X0010</span><span class="token punctuation">;</span>			<span class="token comment">//login函数固定消息长度为16位</span>
    <span class="token keyword">char</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//login函数的padding为16位</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> a<span class="token operator">:</span>account<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> a<span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        ous<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//将信息写入ous后传递给server</span>
        ous<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ous<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ous<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>padding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ous<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>服务端：</strong></p> <p>我们同样需要重写一下服务端程序以适应程序要求</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建服务器对象,并指定端口号</span>
    <span class="token class-name">ServerSocket</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务器已经建立......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Socket</span> socket <span class="token operator">=</span>server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端连接进来了......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当有客户端连接进来以后，开启一个线程，用来处理该客户端的逻辑,</span>
        <span class="token class-name">ServerThread</span> st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerThread</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        st<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//添加该客户端到容器中</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>同时完成一下与客户端的交互部分：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取输入输出流</span>
        ins <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ous <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PrintWriter</span> printWriter<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>ous<span class="token punctuation">)</span><span class="token punctuation">;</span>
        printWriter<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;请登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ous<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        printWriter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ins<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ous<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> ifError<span class="token operator">=</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ifError<span class="token operator">==</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ins<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ous<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将当前已经关闭的客户端从容器中移除</span>
            <span class="token class-name">MyServer</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>同时由于协议前32位固定，故我们的解析函数可以先进行统一解析：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> ins<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> head<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    head<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ins<span class="token punctuation">.</span><span class="token function">readNBytes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>head<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>VERSION<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">short</span> len1<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>head<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">short</span> len<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>len1<span class="token operator">+</span>head<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> messageType<span class="token operator">=</span>head<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>content<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
        content<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>ins<span class="token punctuation">.</span><span class="token function">readNBytes</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>messageType<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//登录</span>
        <span class="token punctuation">{</span>
            <span class="token function">loginReply</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span>ous<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//versionWrong();</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当messageType为1时调用loginReply回复客户端消息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loginReply</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">,</span> <span class="token class-name">OutputStream</span> ous<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> name<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token comment">//读取名字</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">+=</span>content<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">MyServer</span><span class="token punctuation">.</span>namelist<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//构建login_reply errorcode=1的消息</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//构建login_reply errorcode=0的消息</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这样基本的函数交互就完成了，后续我们需要以类似格式完成其他函数的交互</p> <p>ps：由于今天去老家看望了老人，所以实现内容少于预期，争取明天补回来</p> <hr> <h3 id="day0x04-06"><a href="#day0x04-06" class="header-anchor">#</a> Day0x04-06</h3> <p>这几天放假的功夫加上周一，我将之前的1A里的功能全部进行了一些实现，同时修正了一些可能出现的bug,也重构了一些代码，具体情况如下：</p> <p>首先，针对<strong>服务端</strong>，仔细思考后决定将结构重构</p> <p>首先定义三个数据结构用于存储玩家信息等</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Client</span><span class="token punctuation">&gt;</span></span> clients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//客户端信息</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> namelist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//角色是否在线</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span>player<span class="token punctuation">&gt;</span></span>playerdata<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//角色的属性，player为自定义类型</span>
</code></pre></div><p>MyServer先通过main函数调用init</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">MyServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>init中<strong>多线程创建</strong>服务器对象，同时将服务器存入clients的map中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建服务器对象,并指定端口号</span>
    <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Socket</span> socket<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Client</span> client<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务器已经建立......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        socket <span class="token operator">=</span>serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;连接上客户端&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>单独再写一个Client类继承runnable接口放在上面的Myserver里，<strong>对应一个客户端</strong>，客户端登录后获得人物相关参数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> playername<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> hp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> exp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">DataInputStream</span> dataInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">DataOutputStream</span> dataOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> isLogin<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre></div><p>然后在构造函数中初始化流参数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token operator">=</span>socket<span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        inputStream<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息接收失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    dataOutputStream<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataInputStream<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在run中循环执行read，直到关闭客户端</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>dataInputStream<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                message<span class="token operator">=</span>dataInputStream<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户下线&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            namelist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>playername<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            isLogin<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// e.printStackTrace();</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EOFException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户下线&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            namelist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>playername<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            isLogin<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// e.printStackTrace();</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接受消息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            namelist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>playername<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            isLogin<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>然后针对<strong>客户端</strong>，为了方便之后写成后的调试工作，将大类MyClient继承runnable接口，通过另外的类多次调用他来实现多个玩家的登录模拟，每个客户端有下列参数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> VERSION<span class="token operator">=</span><span class="token number">0X04</span><span class="token punctuation">;</span>   <span class="token comment">//版本号</span>
<span class="token keyword">private</span> <span class="token class-name">DataInputStream</span> dataInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">DataOutputStream</span> dataOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> playername<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> HP<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> EXP<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token class-name">X</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token class-name">Y</span><span class="token punctuation">;</span>
<span class="token keyword">public</span>  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> player<span class="token punctuation">&gt;</span></span> playerseen<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//能被看到的角色</span>
</code></pre></div><p>客户端内为了实现<strong>接收消息与发送消息的并发</strong>，我们将这两类操作分离开来分别继承runnable接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ReciveMessage</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SendMessage</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
</code></pre></div><p>然后对不同操作进行分类处理</p> <p>接下来对每一个具体的功能进行<strong>从客户端到服务器的交互解析</strong>：</p> <h4 id="login全过程"><a href="#login全过程" class="header-anchor">#</a> Login全过程</h4> <ul><li>首先服务器开启等待连接，客户端调用connect函数<strong>连接</strong>，然后<strong>启动接发消息的线程</strong>：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;成功与服务器建议连接&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;申请链接失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//首先进行连接</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReciveMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动接收消息的线程</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动发送消息的线程</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>然后ReciveMessage线程阻塞等待接收服务器端消息，sendMessage线程等待命令行输入指令</li></ul> <p>此时按格式输入： login playername</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SendMessage</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Scanner</span> sc<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            sc<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> command<span class="token operator">=</span>sc<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">handleCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre></div><p>进入到上述handleCommand函数中，对于login：按空格分离命令，获得后面的playername名，然后调用login函数传入名字</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCommand</span><span class="token punctuation">(</span><span class="token class-name">String</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token operator">=</span>command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>names<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name<span class="token operator">=</span>names<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">login</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;输出格式有误，格式为: login &lt;player_name&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>login函数按login协议构造报文，注意这里的位操作：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span>  <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//一共是16个8位</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>				<span class="token comment">//1字节用于存版本号</span>
    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>					<span class="token comment">//2,3字节存总长度，由于login指令定长，故为此</span>
    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0010</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">;</span>				<span class="token comment">//4字节存指令编号，0x01代表login</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>					<span class="token comment">//后面存名字，最大为10字节（9字节其实，最后一位必须为空）</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>na<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>account<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
        na<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">14</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    playername<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>na<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendMessageToServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//调用send将构造的报文传到服务端</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后调用sendmessageToserver传输文本</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessageToServer</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        dataOutputStream<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时server接收到消息，下图处解除阻塞，调用服务器的handleMessage</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>dataInputStream<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                message<span class="token operator">=</span>dataInputStream<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待读入客户端发来的数据</span>
                <span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>handleMessage根据接收到的指令进行解析：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteMessage<span class="token operator">=</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//首先用字节的形式转换信息</span>
    <span class="token keyword">byte</span> version<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">//得到版本</span>
    <span class="token keyword">char</span> len<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>byteMessage<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>byteMessage<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到长度</span>
    <span class="token keyword">byte</span> msgType<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">//得到信息类型</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>version<span class="token operator">==</span>VERSION<span class="token punctuation">)</span>    <span class="token comment">//版本一致</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//login_request处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x01</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>tempName<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">//获取到名字</span>
            <span class="token class-name">String</span> name<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>tempName<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//将名字转成string</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>isLogin<span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//登录阶段以后登录，发送0x0b的1号错误信息</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
                mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0008</span><span class="token punctuation">;</span>
                mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0b</span><span class="token punctuation">;</span>
                mes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>namelist<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token comment">//信息库存在该角色</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>namelist<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//该角色在线，发送0x02的1号错误信息</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0010</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x02</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>                        <span class="token comment">//该角色不在线，则从map中读入该角色信息</span>
                <span class="token punctuation">{</span>
                    player currentPlayer <span class="token operator">=</span> playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0010</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x02</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span>
                    hp<span class="token operator">=</span>currentPlayer<span class="token punctuation">.</span>HP<span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    exp<span class="token operator">=</span>currentPlayer<span class="token punctuation">.</span>EXP<span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    mes<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> currentPlayer<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                    mes<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> currentPlayer<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                    playername<span class="token operator">=</span>name<span class="token punctuation">;</span>
                    isLogin<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>	<span class="token comment">//将此线程对应客户端设置为已登录状态</span>
                    namelist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">//将该角色信息以move_notify形式发送给其他角色，参数1代表发送给自己以外其他角色</span>
                    <span class="token function">move_notify</span><span class="token punctuation">(</span>playername<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span>player<span class="token punctuation">&gt;</span></span>entry<span class="token operator">:</span>playerdata<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">move_notify</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将其他角色信息以move_notify发送给自己，参数0代表发送给自己</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//没有该角色，则创建该角色，并随机初始数值</span>
            namelist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            playername<span class="token operator">=</span>name<span class="token punctuation">;</span>
            isLogin<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token class-name">Random</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hp<span class="token operator">=</span><span class="token number">100</span><span class="token operator">+</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            x<span class="token operator">=</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            y<span class="token operator">=</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            player currentPlayer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">player</span><span class="token punctuation">(</span>hp<span class="token punctuation">,</span>exp<span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            playerdata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>currentPlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0010</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x02</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>hp<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mes<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>exp<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mes<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> x<span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> y<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

            <span class="token function">move_notify</span><span class="token punctuation">(</span>playername<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//同上</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span>player<span class="token punctuation">&gt;</span></span>entry<span class="token operator">:</span>playerdata<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">move_notify</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>此时服务器接收到客户端的应答消息，reciveMessage解除阻塞，调用客户端的handleMessage处理消息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ReciveMessage</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> message <span class="token operator">=</span> dataInputStream<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取消息</span>
                <span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteMessage<span class="token operator">=</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span> version<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> len<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>byteMessage<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>byteMessage<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span> msgType<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>version<span class="token operator">==</span>VERSION<span class="token punctuation">)</span>    <span class="token comment">//版本一致</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token comment">//如果接收到的消息是 login_reply</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>	<span class="token comment">//如果是0号错误信息，则为正确，按发送过来的信息初始化角色信息并提示</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome to the tiny world of warcraft.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> hp1<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> hp2<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> hp3<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> hp4<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                HP<span class="token operator">=</span>hp1<span class="token operator">+</span>hp2<span class="token operator">+</span>hp3<span class="token operator">+</span>hp4<span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;your HP:&quot;</span><span class="token operator">+</span>HP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> exp1<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> exp2<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> exp3<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> exp4<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                EXP<span class="token operator">=</span>exp1<span class="token operator">+</span>exp2<span class="token operator">+</span>exp3<span class="token operator">+</span>exp4<span class="token punctuation">;</span>
                <span class="token class-name">X</span><span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">Y</span><span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;your EXP:&quot;</span><span class="token operator">+</span>EXP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;your location: X=&quot;</span><span class="token operator">+</span><span class="token class-name">X</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;your location: Y=&quot;</span><span class="token operator">+</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;--------------------------------------------------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//如果是1号错误信息，说明已有同名角色，按协议提示</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;A play with the same name is already in the game.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>至此，完整的login交互完成，下面是动图演示，包含了登录，重复登录处理，多客户端登录请求：</p> <p><img src="http://image.leesdog.space/jwlogin1.gif" alt=""></p> <hr> <h4 id="move全过程"><a href="#move全过程" class="header-anchor">#</a> move全过程</h4> <p>接下来是move，首先是客户端调用move指令，格式为move &lt;north|south|east|west&gt;</p> <p>和上面login一样，所以这里我就直接进入到处理过程了：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCommand</span><span class="token punctuation">(</span><span class="token class-name">String</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;move&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//System.out.println(&quot;请输入方向对应的编号，0为North北，1为South南，2为East东，3为West西&quot;);</span>
        <span class="token keyword">int</span> direction<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> directions<span class="token operator">=</span>command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>directions<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">String</span> comm<span class="token operator">=</span>directions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>comm<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;north&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                direction<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>comm<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;south&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                direction<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>comm<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;east&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                direction<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>comm<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;west&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                direction<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token function">move</span><span class="token punctuation">(</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//最终以move指令int传出</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;输出格式有误，格式为: move &lt;north|south|east|west&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">int</span> direction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//构造一个8字节的报文</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0008</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x03</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> direction<span class="token punctuation">;</span>
    <span class="token function">sendMessageToServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>消息传到服务器，服务器这边对其做处理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//move</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x03</span><span class="token punctuation">)</span>	
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isLogin<span class="token operator">==</span><span class="token boolean">true</span><span class="token comment">//登录了</span>
    <span class="token punctuation">{</span>
        <span class="token function">move</span><span class="token punctuation">(</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//调用服务器端的move函数</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>	<span class="token comment">//未登录就使用指令，构建0x0b报文并设置0错误参数返回</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0008</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0b</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//根据不同的int方向进行处理</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//North</span>
    <span class="token punctuation">{</span>
        y<span class="token operator">+=</span><span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">&gt;</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token comment">//过99则-100，因为地图为环形</span>
        <span class="token punctuation">{</span>
            y<span class="token operator">-=</span><span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        player currentPlayer<span class="token operator">=</span> playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playername<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获得当前角色的属性信息，并对x，y进行相应修改</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>currentPlayer<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            currentPlayer<span class="token punctuation">.</span>y<span class="token operator">=</span>y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//South</span>
    <span class="token punctuation">{</span>
        y<span class="token operator">-=</span><span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            y<span class="token operator">+=</span><span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        player currentPlayer<span class="token operator">=</span> playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playername<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>currentPlayer<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            currentPlayer<span class="token punctuation">.</span>y<span class="token operator">=</span>y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">//East</span>
    <span class="token punctuation">{</span>
        x<span class="token operator">-=</span><span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            x<span class="token operator">+=</span><span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        player currentPlayer<span class="token operator">=</span> playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playername<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>currentPlayer<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            currentPlayer<span class="token punctuation">.</span>x<span class="token operator">=</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">//West</span>
    <span class="token punctuation">{</span>
        x<span class="token operator">+=</span><span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">&gt;</span><span class="token number">99</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            x<span class="token operator">-=</span><span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        player currentPlayer<span class="token operator">=</span> playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playername<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>currentPlayer<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            currentPlayer<span class="token punctuation">.</span>x<span class="token operator">=</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">move_notify</span><span class="token punctuation">(</span>playername<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//最后调用move_notify返回消息给客户端</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">move_notify</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token keyword">int</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0018</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x04</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>name<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//存入角色名</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">14</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    player currentPlayer<span class="token operator">=</span>playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获得该角色信息并存入</span>
    mes<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> currentPlayer<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> currentPlayer<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">int</span> chp<span class="token operator">=</span>currentPlayer<span class="token punctuation">.</span>HP<span class="token punctuation">;</span>
    <span class="token keyword">int</span> cexp<span class="token operator">=</span>currentPlayer<span class="token punctuation">.</span>EXP<span class="token punctuation">;</span>

    mes<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>chp<span class="token operator">&amp;</span><span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>chp<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>chp<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>chp<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mes<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cexp<span class="token operator">&amp;</span><span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cexp<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cexp<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cexp<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>model<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>model<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">sendToAllClientsOutOfSelf</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>model<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>				<span class="token comment">//此时参数为2，即发送此消息给所有客户端</span>
            <span class="token function">sendToAllClients</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendToAllClients</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Client</span> c <span class="token operator">:</span> clients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outputStream <span class="token operator">=</span> c<span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dataOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sendToClient</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时客户端接收到move_notify消息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token comment">//move_notify</span>
<span class="token punctuation">{</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>tempName<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//提取名字与坐标</span>
    <span class="token keyword">byte</span> locationX<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span> locationY<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> hp1<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>	<span class="token comment">//提取各属性信息</span>
    <span class="token keyword">int</span> hp2<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hp3<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hp4<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hp<span class="token operator">=</span>hp1<span class="token operator">+</span>hp2<span class="token operator">+</span>hp3<span class="token operator">+</span>hp4<span class="token punctuation">;</span>

    <span class="token keyword">int</span> exp1<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> exp2<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> exp3<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> exp4<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> exp<span class="token operator">=</span>exp1<span class="token operator">+</span>exp2<span class="token operator">+</span>exp3<span class="token operator">+</span>exp4<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>tempName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>playername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//接到自己的数据</span>
    <span class="token punctuation">{</span>
        HP<span class="token operator">=</span>hp<span class="token punctuation">;</span>
        EXP<span class="token operator">=</span>exp<span class="token punctuation">;</span>
        <span class="token class-name">X</span><span class="token operator">=</span>locationX<span class="token punctuation">;</span>
        <span class="token class-name">Y</span><span class="token operator">=</span>locationY<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>playername<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">&quot;: location=(&quot;</span> <span class="token operator">+</span><span class="token class-name">X</span><span class="token operator">+</span><span class="token string">&quot;,&quot;</span><span class="token operator">+</span><span class="token class-name">Y</span><span class="token operator">+</span><span class="token string">&quot;), HP=&quot;</span><span class="token operator">+</span>HP<span class="token operator">+</span><span class="token string">&quot;, EXP=&quot;</span><span class="token operator">+</span>EXP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token comment">//接收到其他人的数据</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>locationX<span class="token operator">&lt;=</span><span class="token class-name">X</span><span class="token operator">+</span><span class="token number">5</span><span class="token operator">&amp;&amp;</span>locationX<span class="token operator">&gt;=</span><span class="token class-name">X</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">&amp;&amp;</span>locationY<span class="token operator">&lt;=</span><span class="token class-name">Y</span><span class="token operator">+</span><span class="token number">5</span><span class="token operator">&amp;&amp;</span>locationY<span class="token operator">&gt;=</span><span class="token class-name">Y</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment">//视线范围内的消息才做反应</span>
        <span class="token punctuation">{</span>
            player p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">player</span><span class="token punctuation">(</span>hp<span class="token punctuation">,</span>exp<span class="token punctuation">,</span>locationX<span class="token punctuation">,</span>locationY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            playerseen<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>tempName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>tempName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">&quot;: location=(&quot;</span> <span class="token operator">+</span>locationX<span class="token operator">+</span><span class="token string">&quot;,&quot;</span><span class="token operator">+</span>locationY<span class="token operator">+</span><span class="token string">&quot;), HP=&quot;</span><span class="token operator">+</span>hp<span class="token operator">+</span><span class="token string">&quot;, EXP=&quot;</span><span class="token operator">+</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>至此，完整的move全过程实现完成，下面是动图演示，包含move各个方向以及部分错误处理；第二张图演示move后发现其他角色：
<img src="http://image.leesdog.space/jwmove1.gif" alt="1"> <img src="http://image.leesdog.space/jwmove2.gif" alt=""></p> <p><img src="http://image.leesdog.space/jwmove3.gif" alt=""></p> <hr> <h4 id="attack全过程"><a href="#attack全过程" class="header-anchor">#</a> attack全过程</h4> <p>接下来是attack的全过程，首先客户端输入相应指令attack &lt;player_name&gt;</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;attack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">String</span> people<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>attacks<span class="token operator">=</span>command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>attacks<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        people<span class="token operator">=</span>attacks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">attack</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获得要攻击的人的名字，调用attack</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;输出格式有误，格式为: attack &lt;player_name&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>调用attack函数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attack</span><span class="token punctuation">(</span><span class="token class-name">String</span> people<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>playerseen<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//如果自己的可视表里有该角色才能执行攻击操作</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//构造报文信息</span>
        mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0010</span><span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x05</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>people<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">14</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sendMessageToServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送至服务器</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;The target is not visible.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>服务器这边进行处理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x05</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isLogin<span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>tempName<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">attack</span><span class="token punctuation">(</span>tempName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0008</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0b</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>然后调用服务器的attack</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attack</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tempName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> people<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>tempName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Random</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//生成一个范围内的随机伤害</span>
    <span class="token keyword">int</span> damage<span class="token operator">=</span><span class="token number">10</span><span class="token operator">+</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playername<span class="token punctuation">)</span><span class="token punctuation">.</span>EXP<span class="token operator">+=</span>damage<span class="token punctuation">;</span>
    playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">.</span>HP<span class="token operator">-=</span>damage<span class="token punctuation">;</span>
    <span class="token function">attack_notify</span><span class="token punctuation">(</span>people<span class="token punctuation">,</span>damage<span class="token punctuation">,</span>playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">.</span>HP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">.</span>HP<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">//死亡</span>
    <span class="token punctuation">{</span>
        playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">.</span>HP<span class="token operator">=</span><span class="token number">30</span><span class="token operator">+</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token operator">=</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerdata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token operator">=</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">move_notify</span><span class="token punctuation">(</span>people<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送该角色新状态消息</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>最后调用attack_notify回传消息给客户端：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attack_notify</span><span class="token punctuation">(</span><span class="token class-name">String</span> people<span class="token punctuation">,</span><span class="token keyword">int</span> damage<span class="token punctuation">,</span><span class="token keyword">int</span> HP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0020</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x06</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>playername<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">14</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>people<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">24</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mes<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> damage<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HP<span class="token operator">&amp;</span><span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HP<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HP<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>HP<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">sendToAllClients</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>然后客户端这边接收到attack_notify消息,处理发送过来的内容</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token comment">//attack_notify</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>attackerName<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>victimName<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>byteMessage<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> damage<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> hp1<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> hp2<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> hp3<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> hp4<span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> hp<span class="token operator">=</span>hp1<span class="token operator">+</span>hp2<span class="token operator">+</span>hp3<span class="token operator">+</span>hp4<span class="token punctuation">;</span>
                    <span class="token class-name">String</span> vic<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>victimName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> att<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>attackerName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span>playerseen<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>vic<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>playerseen<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>att<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token operator">||</span>  <span class="token punctuation">(</span> att<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>playername<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span>vic<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>playername<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span>       <span class="token punctuation">)</span><span class="token comment">//两者均在视线内或者两者之一是自己</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>hp<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                           <span class="token comment">// &lt;attacker name&gt; damaged &lt;victim name&gt; by &lt;damage&gt;. &lt;victim name&gt;’s HP is now &lt;HP&gt;.</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>attackerName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; damage &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>victimName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; by &quot;</span><span class="token operator">+</span>damage<span class="token operator">+</span><span class="token string">&quot;. &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>victimName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;'s HP is now &quot;</span><span class="token operator">+</span>hp<span class="token operator">+</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span>
                        <span class="token punctuation">{</span>
                            <span class="token comment">//&lt;attacker name&gt; killed &lt;victim name&gt;.</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>attackerName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; killed &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>victimName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
</code></pre></div><p>至此，attack全过程实现完毕，下面是演示动图，包括了基本的攻击，攻击视野外玩家，攻击致死等情况：</p> <p><img src="http://image.leesdog.space/jwmove4.gif" alt=""></p> <hr> <h4 id="speak全过程"><a href="#speak全过程" class="header-anchor">#</a> speak全过程</h4> <p>speak全过程相对比较简单，不过需要注意的是前面的指令全是定长指令，而speak为非定长指令</p> <p>首先客户端调用speak获取其后面的内容</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;speak&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">String</span> message<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>speaks<span class="token operator">=</span>command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>speaks<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        message<span class="token operator">=</span>speaks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">speak</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">speak</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>message<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">255</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">char</span> len<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将长度转换成两个字节表示</span>
        mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>len<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x07</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>message<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
            mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sendMessageToServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>调用完speak将信息传到服务器，服务器进行处理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//speak</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x07</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isLogin<span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>speakmessage<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            speakmessage<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//4为头部的</span>
        <span class="token punctuation">}</span>
        <span class="token function">speak_notify</span><span class="token punctuation">(</span>speakmessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>然后调用speak_notify</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">speak_notify</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> speakmessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span>speakmessage<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">14</span><span class="token punctuation">;</span><span class="token comment">//构建报文信息，加的14是头部信息4字节+发送者名字10字节</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len<span class="token operator">&amp;</span><span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>len<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>playername<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">14</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>speakmessage<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">sendToAllClients</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后传回客户端进行处理显示：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//speak_notify</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x08</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>MES<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>speakerName<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MES<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span>byteMessage<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>speakerName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>MES<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，speak全过程实现完毕，下面是动图演示多客户端情况下的信息交互：</p> <p><img src="http://image.leesdog.space/jwmove5.gif" alt=""></p> <hr> <h4 id="logout全过程"><a href="#logout全过程" class="header-anchor">#</a> logout全过程</h4> <p>首先客户端调用logout指令</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>按协议构建报文0x09号报文</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0004</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x09</span><span class="token punctuation">;</span>
    <span class="token function">sendMessageToServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>转发到服务器，服务器这边进行相关处理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//logout</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x09</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isLogin<span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">logout_notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//直接调用logout_notify</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0008</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0b</span><span class="token punctuation">;</span>
        m<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">sendToClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">logout_notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>mes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>VERSION<span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0010</span><span class="token punctuation">;</span>
    mes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0a</span><span class="token punctuation">;</span>
    namelist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>playername<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将该玩家设为离线</span>
    isLogin<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>					<span class="token comment">//将该客户端设为未登录状态</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>playername<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
        mes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">14</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">sendToAllClients</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//告知所有客户端</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后返回到客户端进行广播，注意<strong>删除客户端内该可视角色的信息</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgType<span class="token operator">==</span><span class="token number">0x0a</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>loggoutName<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>byteMessage<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>byteMessage<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>loggoutName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;已退出游戏&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>playerseen<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>loggoutName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> playerseen<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>loggoutName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，logout全过程实现完毕，下面是动图演示，主要包括客户端的登出以及广播：</p> <p><img src="http://image.leesdog.space/jwlogoutgif" alt=""></p> <hr> <h4 id="invalid-state"><a href="#invalid-state" class="header-anchor">#</a> invalid_state</h4> <p>在两种情况下会出现上述这种情况，不过前面的动图中其实也已经演示过了，这里单独再演示一遍：</p> <p><img src="http://image.leesdog.space/jwinvalid.gif" alt=""></p> <hr> <p>到这里，基本上可以说第一部分的内容应该是完成了，其中我也修复了很多bug，也是花了不少的时间，尤其是在attack这部分；但是由于使用的是java，没有办法跑老师的测试代码，这一点我还在想怎么办。。还有就是目前刚刚看了一下2A的内容，明天打算尝试着搞一下2A试试</p> <hr> <h3 id="day0x07"><a href="#day0x07" class="header-anchor">#</a> Day0x07</h3> <p>今天主要先来探究一下2A部分的内容，根据我的一些初步理解（应该算中步理解，因为和最开始的理解已经有很大不同了），这里我们主要处理重构的是login、move与logout这仨方法，同时也要将服务器的一些结构进行更改，开始写代码写的越来越乱，故整理了一下思路，将所有过程全部过了一遍，根据我当前的理解，目前想到的一些比较关键的点是：</p> <ul><li><p>客户端调用login指令时首先是通过udp 0x00号消息发送给tracker，tracker对<strong>一号指定服务器</strong>发送<strong>getMes tcp</strong>报文（getMes报文需要自构，主要功能就是请求该角色信息，如果存在则返回角色信息，不存在则在一号服务器内创建；这里我思来想去还是确定一个固定的请求客户端，虽然该请求角色的位置判定可能不在该客户端内，但由于服务器整体存有角色信息，依旧可以取到角色的信息，返回以后tracker再根据角色的具体坐标返回相应的服务器信息）</p></li> <li><p>生成玩家时玩家的坐标<strong>只能是该服务器管辖范围内坐标</strong></p></li> <li><p>得到对应坐标消息以后根据坐标在tracker里计算出相应对应的服务器，然后从存有xml信息的map中取出该服务器ip，udp信息，根据协议这里我们以udp 0x01消息返回，ip，udp信息给客户端</p></li> <li><p>现在整体的login功能全过程应该是：</p> <p>1.构建udp 0x00消息给tracker，让tracker发送getMes tcp报文给一号服务器，获得返回的message（带有角色属性信息）后根据x，y坐标返回该角色对应ip，udp端口</p> <p>上述整体过程为：<strong>客户端-&gt;tracker-&gt;服务器-&gt;tracker-&gt;客户端，客户端获得服务器ip+udp端口</strong></p> <p>2.客户端根据上述获得的端口消息构建udp 0x04消息发送给服务器，服务器返回0x05 udp消息</p> <p>上述整体过程为：<strong>客户端-&gt;服务器，客户端获得角色属性信息</strong></p> <p>3.客户端根据上述获得的坐标等消息构建udp发送给tracker获得服务器的tcp端口</p> <p>上述整体过程为：<strong>客户端-&gt;tracker，客户端获得服务器tcp端口</strong></p> <p>4.tcp连接客户端与服务器</p> <p>5.根据消息发送tcp login请求，这里的login已经被重构成2A里的新协议要求</p></li> <li><p>logout处需要<strong>首先进行save操作</strong>，然后返回的消息也需要进行重构</p></li> <li><p>这里需要注意的一点是udp消息是<strong>不可靠传输</strong>，且是无需要保持连接的，所以如何实现较为可靠的传输也是一个问题</p></li> <li><p>tracker与客户端之间的udp连接端口可以<strong>事先就进行约定</strong>，而tracker与服务器之间的udp连接端口由于<strong>约定了传输1号服务器</strong>故也因此可以解决</p></li></ul> <p>今天本来是直接写代码的，但是写了半天以后发现了很多问题，于是静下心来决定将整个更改后的传输全过程好好理一下，然后再去写代码，这才得到了上面的一些我的思考，同时由于udp的不可靠性，要想实现可靠传输需要在应用层加上tcp协议层就实现的事情，例如包的编号，重传以及三次握手（协议里已经提到了一些解决方案，例如udp协议都会有一个id，通过每次传输请求后+1的方式也就实现了编号与消息的对应），这一块的内容还是很麻烦的，明天尝试先实现以下udp的可靠传输试一试</p></div> <footer></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#计算机网络课程设计" title="计算机网络课程设计">计算机网络课程设计</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#题目描述" title="题目描述">题目描述</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#系统需求概述" title="系统需求概述">系统需求概述</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#功能性需求" title="功能性需求">功能性需求</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#非功能性需求" title="非功能性需求">非功能性需求</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#day0x01" title="Day0x01">Day0x01</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#解压安装包jdk-8u202-linux-x64-demos-tar-gz" title="解压安装包jdk-8u202-linux-x64-demos.tar.gz">解压安装包jdk-8u202-linux-x64-demos.tar.gz</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#将解压后的文件移到-usr-lib目录下" title="将解压后的文件移到/usr/lib目录下">将解压后的文件移到/usr/lib目录下</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#配置java环境变量" title="配置java环境变量">配置java环境变量</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#执行命令使修改立即生效" title="执行命令使修改立即生效">执行命令使修改立即生效</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#day0x02" title="Day0X02">Day0X02</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#day0x03" title="Day0X03">Day0X03</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#day0x04-06" title="Day0x04-06">Day0x04-06</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#day0x07" title="Day0x07">Day0x07</a></div></div></div></div> <footer class="footer" data-v-c7481560><div class="footer-left-wrap" data-v-c7481560><ul class="contact" data-v-c7481560><li class="contact-item" data-v-c7481560><a href="https://github.com/AbsoluteZeroKing" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-c7481560><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-c7481560><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-c7481560></path></svg>
          
        </a></li><li class="contact-item" data-v-c7481560><a href="mailto:1932940046@qq.com" class="nav-link external" data-v-c7481560><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-c7481560><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-c7481560></path><polyline points="22,6 12,13 2,6" data-v-c7481560></polyline></svg>
          
        </a></li><li class="contact-item" data-v-c7481560><a href="/" class="nav-link" data-v-c7481560><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-square" data-v-c7481560><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" data-v-c7481560></path></svg>
          
        </a></li><li class="contact-item" data-v-c7481560><a href="/" class="nav-link" data-v-c7481560><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-music" data-v-c7481560><path d="M9 18V5l12-2v13" data-v-c7481560></path><circle cx="6" cy="18" r="3" data-v-c7481560></circle><circle cx="18" cy="16" r="3" data-v-c7481560></circle></svg>
          
        </a></li><li class="contact-item" data-v-c7481560><a href="tel:18064044601" class="nav-link external" data-v-c7481560><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-phone" data-v-c7481560><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" data-v-c7481560></path></svg>
          
        </a></li><li class="contact-item" data-v-c7481560><a href="/" class="nav-link" data-v-c7481560><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video" data-v-c7481560><polygon points="23 7 16 12 23 17 23 7" data-v-c7481560></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2" data-v-c7481560></rect></svg>
          
        </a></li><li class="contact-item" data-v-c7481560><a href="https://leesdog.space/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-c7481560><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-globe" data-v-c7481560><circle cx="12" cy="12" r="10" data-v-c7481560></circle><line x1="2" y1="12" x2="22" y2="12" data-v-c7481560></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" data-v-c7481560></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-c7481560><ul class="copyright" data-v-c7481560><li class="copyright-item" data-v-c7481560><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-c7481560>鄂ICP备19020804号-2</a></li><li class="copyright-item" data-v-c7481560>MIT Licensed</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.762240e8.js" defer></script><script src="/assets/js/7.ac404b9a.js" defer></script><script src="/assets/js/5.7b7cf407.js" defer></script><script src="/assets/js/27.c846cf16.js" defer></script><script src="/assets/js/8.b02a8171.js" defer></script>
  </body>
</html>
